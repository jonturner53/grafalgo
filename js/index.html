<!doctype html5>
<html>
<head>
<style>

.headerFooter {
	position: absolute;
	background-color: navy;
	margin: 0px;
	font-family: "Verdana", sans-serif;
	color: cyan;
}

.stdButton {
	padding: 1px 5px 1px 5px;
	border: 1px solid black;
	background-color: beige;
	font-family: "Verdana", sans-serif;
	font-size: 100%;
	border-radius: 5px;
}

.fixedWidthButton {
	width: 85;
	border: 1px solid black;
	margin: 1px 0px 1px 0px;
	padding: 1px 1px 1px 1px;
	background-color: beige;
	font-family: "Verdana", sans-serif;
	font-size: 100%;
	border-radius: 5px;
}

.smallButton {
	width: 13px;
	height: 13px;
	border: 1px solid black;
	padding: 0px 0px 2px 0px;
	margin: 0px 0px 0px 0px;
	background-color: beige;
	border-radius: 2px;
}
</style>
</head>

<body>
<div style="position:absolute; width: 750px; height: 565;
			border-style: solid; border-width: 1px;">

	<div id="header" class="headerFooter"
		 style="top: 1; left: 1; width: 748;
				text-align: center; padding: 4px 0 4px 0;"
	>Graph Algorithms and Data Structures</div>

	<textarea id="codeArea"
		style="position: absolute; left: 3; top: 30;
		width: 600; height: 265;
		color: black; font-family: courier; font-size: 75%;"
	></textarea>

	<textarea id="outputArea"
		style="position: absolute; left: 3; bottom: 2;
		width: 600; height: 265;
		color: black; font-family: courier; font-size: 75%;"
	></textarea>

	<div style="font-family: Verdana; font-size: 75%; position: absolute;
			   top:30; left:605;">
		data structures<br>
		<button id="dstructButton" class="smallButton"></button>
		<select id="dstructMenu" style="font-size: 100%; width:120">
		</select>
	</div>
	<div style="font-family: Verdana; font-size: 75%; position: absolute;
			   top:65; left:605;">
		<button id="testDstructButton" class="smallButton"></button>
		<select id="testDstructMenu" style="font-size: 100%; width:120">
		</select>
	</div>

	<div style="font-family: Verdana; font-size: 75%; position: absolute;
			   top:90; left:605;">
		algorithms<br>
		<button id="algoButton" class="smallButton"></button>
		<select id="algoMenu" style="font-size: 100%; width:120">
		</select>
	</div>
	<div style="font-family: Verdana; font-size: 75%; position: absolute;
			   top:125; left:605;">
		<button id="testAlgoButton" class="smallButton"></button>
		<select id="testAlgoMenu" style="font-size: 100%; width:120">
		</select>
	</div>

	<div style="font-family: Verdana; font-size: 75%; position: absolute;
			   top:150; left:605;">
		common<br>
		<button id="commonButton" class="smallButton"></button>
		<select id="commonMenu" style="font-size: 100%; width:120">
		</select>
	</div>

	<div style="font-family: Verdana; font-size: 80%;
				position: absolute; top: 200; left: 605;">
		<button id="scratchButton" class="fixedWidthButton">scratch pad</button>
	</div>

	<input type="text" size="19" value="" id="argString"
               style="position: absolute; top: 300; left: 605; font-size: 80%"
	>

	<div style="font-family: Verdana; font-size: 80%;
				position: absolute; top: 323; left: 605;">
		<button id="runButton" class="fixedWidthButton">run</button>
	</div>

	<div style="font-family: Verdana; font-size: 80%;
				position: absolute; top: 347; left: 605;">
		<button id="clearButton" class="fixedWidthButton">clear</button>
	</div>
</div>

<script type="module">
/** Send a get request and process reply.
 *  @param path is a relative path to the file to be retrieved.
 *  @return a promise; use the promises then() method to define
 *  the handler for the reply; use catch() method to handler errors
 */
function serverRequest(path, args=[]) {
	return new Promise(function(resolve, reject) {
		let request = new XMLHttpRequest();
		request.open("GET", path, true);
		request.onload = function() {
			if (this.responseText.startsWith("Error")) {
				console.log('serverRequest error:\n' +
						 '\trequest: ' + commandString + '\n' +
						 '\tresponse: ' + this.responseText + '\n');
				if (reject) reject();
			} else if (resolve) {
				if (args.length == 0) resolve(this.responseText);
				else resolve([this.responseText].concat(args));
			}
		}
		request.onerror = function() {
			if (reject) {
				reject(request.status, request.statusText);
			} else {
				console.log("serverRequest Error: " + request.statusText +
							" [" + request.status + "]");
			};
		}
		request.send();
	});
}

import { assert, AssertError } from './common/Errors.mjs';
import { range, shuffle, scramble, randomFraction, randomInteger, randomExp,
		 randomGeometric, randomTruncatedGeometric, randomPareto,
		 randomFill, randomPermutation
	   } from './common/Random.mjs';

import ListSet from './dataStructures/basic/ListSet.mjs';
import ReverseLists from './dataStructures/basic/ReverseLists.mjs';
import Sets from './dataStructures/basic/Sets.mjs';
import List from './dataStructures/basic/List.mjs';
import ListPair from './dataStructures/basic/ListPair.mjs';
import Scanner from './dataStructures/basic/Scanner.mjs';

import Digraph from './dataStructures/graphs/Digraph.mjs';
import Flograph from './dataStructures/graphs/Flograph.mjs';
import Graph from './dataStructures/graphs/Graph.mjs';

import ArrayHeap from './dataStructures/heaps/ArrayHeap.mjs';
import FibHeaps from './dataStructures/heaps/FibHeaps.mjs';
import LeftistHeaps from './dataStructures/heaps/LeftistHeaps.mjs';

import bfs from './graphAlgorithms/misc/bfs.mjs';
import components from './graphAlgorithms/misc/components.mjs';
import dfs from './graphAlgorithms/misc/dfs.mjs';
import findSplit from './graphAlgorithms/misc/findSplit.mjs';
import nca from './graphAlgorithms/misc/nca.mjs';
import { randomGraph, randomDigraph, randomDag, randomBigraph, randomTree,
 		 randomConnectedGraph, randomRegularGraph
	   } from './graphAlgorithms/misc/RandomGraph.mjs';
import toposort from './graphAlgorithms/misc/toposort.mjs';

import mstK from './graphAlgorithms/mst/mstK.mjs';
import mstP from './graphAlgorithms/mst/mstP.mjs';
import mstPf from './graphAlgorithms/mst/mstPf.mjs';
import mstCT from './graphAlgorithms/mst/mstCT.mjs';
import badcase_prim from './graphAlgorithms/mst/badcaseP.mjs';
import mstVerify from './graphAlgorithms/mst/mstVerify.mjs';

import sptDag from './graphAlgorithms/spath/sptDag.mjs';
import sptD from './graphAlgorithms/spath/sptD.mjs';
import sptDf from './graphAlgorithms/spath/sptDf.mjs';
import sptBM from './graphAlgorithms/spath/sptBM.mjs';
import sptVerify from './graphAlgorithms/spath/sptVerify.mjs';

import mfloD from './graphAlgorithms/mflow/mfloD.mjs';

let codeArea = document.getElementById("codeArea");
let outputArea = document.getElementById("outputArea");

/** Substitute for console.log. */
function log() {
	let s = '';
	for (let i = 0; i < arguments.length; i++) 
		s += arguments[i] + ' ';
	outputArea.value += s + '\n';
}

let currentMenu = null;		// when null, scratch pad is selected
function updateCurrentMenu(menu) {
	if (currentMenu == null) {
		scratchPad = codeArea.value;
		scratchButton.style.backgroundColor = 'beige';
	} else {
		currentMenu.deactivate();
	}
	currentMenu = menu; currentMenu.activate();
}

let scratchPad = '// scratch pad\n';
codeArea.value = scratchPad;
let scratchButton = document.getElementById("scratchButton");
scratchButton.style.backgroundColor = 'lightGreen';
scratchButton.addEventListener("click", () => {
	if (currentMenu == null) return;
	currentMenu.deactivate();
	codeArea.value = scratchPad;
	scratchButton.style.backgroundColor = 'lightGreen';
	currentMenu = null;
});

/** Menu class implements selector/button combo */
class Menu {
	constructor(selector, button, path, unit) {
		this.fileContents = '';
		this.selector = selector;
		this.button = button;
		this.selector.addEventListener("change", () => this.select());
		this.button.addEventListener("click", () => this.click());
		this.setup(path, unit);
	}

	/* Initialize selector.innerHTML.
	 * @param dir specifies the (root) directory in which to look for mjs files
	 * @param unit is a flag which specifies that only unit test files
	 * should be included
	 */
	setup(path, unit) {
		this.getFileInfo(path, (reply) => {
			// reply is now a vector of the form
			// [[dir-path file1 file2 ...] [ ditto ] ... ]
			// where dir-path is a directory path and the listed files
			// appear in that directory (some may be sub-directories)
			reply.sort((a,b) => (a[0]<b[0] ? -1 : (a[0]>b[0] ? 1 : 0)));
			let s = ''
			for (let vec of reply) {
				let dir = vec[0].match(/\/[^\/]+\/$/);
				if (dir != null && unit == vec[0].endsWith('/unit/'))
					s += `<optgroup label="${dir[0].slice(1,-1)}"></optgroup>`;
				for (let i = 1; i < vec.length; i++) {
					let f = vec[i];
					if (!f.endsWith('.mjs')) continue;
					if (unit == vec[0].endsWith('/unit/'))
						s += `<option value="${vec[0]+vec[i]}">` +
							 `${vec[i]}</option>`;
				}
			}
			this.selector.innerHTML = s;
		});
	}

	getFileInfo(path, returnValue) {
		if (!path.endsWith('/')) path += '/';
		serverRequest(path)
			.then(function(reply) {
				//extract lists of directories and files from reply
				let vec = [ path ];
				let dirs = []; let files = [];
				let rx = /<a href="([^"]+)"/gm;
				let f = rx.exec(reply);
				while (f != null) {
					if (!f[1].startsWith('/') && f[1].endsWith('/')) {
						dirs.push(f[1]); vec.push(f[1]);
					} else if (f[1].endsWith('.mjs')) {
						vec.push(f[1]);
					}
					f = rx.exec(reply);
				}
				let tvec = [ vec ];
				if (dirs.length == 0) {
					returnValue(tvec); return;
				}
				// for each directory make recursive call
				let count = 0;
				dirs.forEach(function(d) {
					this.getFileInfo(path + d, function(reply) {
							tvec = tvec.concat(reply)
							if (++count == dirs.length)
                            	returnValue(tvec);
                        });
					}.bind(this));
			}.bind(this));
	}

	select() {
		updateCurrentMenu(this);
		let file = this.selector.value;
		serverRequest(file)
			.then(function(reply) {
				this.fileContents = reply.replace(/[\t]/gm, '    ');
				codeArea.value = this.fileContents;
			}.bind(this));
	}

	click() {
		if (this.fileContents == '') {
			this.select();
		} else {
			updateCurrentMenu(this);
			codeArea.value = this.fileContents;
		}
	}

	activate() {
		this.button.style.backgroundColor = 'lightGreen';
		codeArea.value = this.fileContents;
	}

	deactivate() {
		this.button.style.backgroundColor = 'beige';
		this.fileContents = codeArea.value;
	}

}

let dstruct = new Menu(
		document.getElementById("dstructMenu"),
		document.getElementById("dstructButton"),
		'dataStructures/', false
);

let testDstruct = new Menu(
		document.getElementById("testDstructMenu"),
		document.getElementById("testDstructButton"),
		'dataStructures/', true
);

let algo = new Menu(
		document.getElementById("algoMenu"),
		document.getElementById("algoButton"),
		'graphAlgorithms/', false
);

let testAlgo = new Menu(
		document.getElementById("testAlgoMenu"),
		document.getElementById("testAlgoButton"),
		'graphAlgorithms/', true
);

let common = new Menu(
		document.getElementById("commonMenu"),
		document.getElementById("commonButton"),
		'common/', false
);

let clearButton = document.getElementById("clearButton");
clearButton.addEventListener("click", () => { outputArea.value = ''; } );

let runButton = document.getElementById("runButton");
runButton.addEventListener("click", () => {
	eval(codeArea.value.replace(/^[ \t]*import/gm, '// import')
		  				.replace(/console.log/gm, 'log'));
});

let argv = [];
let argString = document.getElementById("argString");
argString.addEventListener('change', () => {
	let s = document.getElementById("argString").value;
	argv = argString.value.trim().split(/ +/);
});

</script>
</body>
</html>
